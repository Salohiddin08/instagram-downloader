{% extends 'downloader/base.html' %}

{% block title %}Download Status - Instagram Video Downloader{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-download"></i> Download Status</h2>
                </div>

                <div class="row" id="statusContainer">
                    <div class="col-md-8">
                        <h5 id="videoTitle">{{ video.title|default:"Processing..." }}</h5>
                        <p class="text-muted mb-2">{{ video.url }}</p>
                        <p class="text-muted small">Started: {{ video.created_at|date:"M d, Y H:i" }}</p>
                        
                        {% if video.error_message %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error: {{ video.error_message }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div id="statusBadge">
                            <span class="badge status-{{ video.status }} fs-5">
                                {% if video.status == 'pending' %}
                                    <i class="fas fa-clock"></i> Pending
                                {% elif video.status == 'downloading' %}
                                    <i class="fas fa-spinner fa-spin"></i> Downloading
                                {% elif video.status == 'completed' %}
                                    <i class="fas fa-check"></i> Completed
                                {% else %}
                                    <i class="fas fa-times"></i> Failed
                                {% endif %}
                            </span>
                        </div>
                        
                        <div id="downloadButton" class="mt-3">
                            {% if video.status == 'completed' %}
                                <a href="{% url 'download_file' video.pk %}" class="btn btn-success">
                                    <i class="fas fa-download"></i> Download File
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-4" id="progressSection">
                    {% if video.status == 'pending' or video.status == 'downloading' %}
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: {% if video.status == 'downloading' %}75%{% else %}25%{% endif %}">
                            </div>
                        </div>
                        <p class="text-center mt-2 small text-muted">
                            {% if video.status == 'pending' %}
                                Preparing download...
                            {% else %}
                                Downloading video...
                            {% endif %}
                        </p>
                    {% endif %}
                </div>

                <div class="mt-4 text-center">
                    <a href="{% url 'home' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-arrow-left"></i> Download Another
                    </a>
                    <a href="{% url 'download_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> View All Downloads
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let videoId = {{ video.pk }};
    let checkInterval;
    
    function checkStatus() {
        $.ajax({
            url: `/api/status/${videoId}/`,
            method: 'GET',
            success: function(data) {
                // Update title
                if (data.title) {
                    $('#videoTitle').text(data.title);
                }
                
                // Update status badge
                let statusClass = `status-${data.status}`;
                let statusText = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                let statusIcon = '';
                
                switch(data.status) {
                    case 'pending':
                        statusIcon = '<i class="fas fa-clock"></i>';
                        break;
                    case 'downloading':
                        statusIcon = '<i class="fas fa-spinner fa-spin"></i>';
                        break;
                    case 'completed':
                        statusIcon = '<i class="fas fa-check"></i>';
                        clearInterval(checkInterval);
                        location.reload(); // Reload to show download button
                        break;
                    case 'failed':
                        statusIcon = '<i class="fas fa-times"></i>';
                        clearInterval(checkInterval);
                        if (data.error_message) {
                            $('#statusContainer').append(`
                                <div class="col-12 mt-3">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Error: ${data.error_message}
                                    </div>
                                </div>
                            `);
                        }
                        $('#progressSection').hide();
                        break;
                }
                
                $('#statusBadge').html(`<span class="badge ${statusClass} fs-5">${statusIcon} ${statusText}</span>`);
                
                // Update progress bar
                if (data.status === 'downloading') {
                    $('.progress-bar').css('width', '75%');
                    $('.progress').next('p').text('Downloading video...');
                } else if (data.status === 'completed' || data.status === 'failed') {
                    $('#progressSection').hide();
                }
            },
            error: function() {
                console.log('Error checking status');
            }
        });
    }
    
    // Check status every 3 seconds if not completed
    if ('{{ video.status }}' !== 'completed' && '{{ video.status }}' !== 'failed') {
        checkInterval = setInterval(checkStatus, 3000);
    }
});
</script>
{% endblock %}